---
title: "AddPointCountSites"
author: "Patrick D. lorch"
date: "2025-04-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Boundary import



```{r bounds}

```

## GRTS

### MGRS grid cell selection

To follow RMH Handbook, starting on pg 54, we download an MGRS grd from https://mgrs-data.org/ (.gdb version) or
https://earth-info.nga.mil/index.php?dir=coordsys&action=mgrs-1km-polyline-dloads (.shp version)

UTM 11S covers our part of CA.

That is stored in SharePoint at "~Southern Sierra Research Station - Documents\Projects\TNC Randall Preserve Projects\Maps & GIS\mgrs_11s_100m" and ""~Southern Sierra Research Station - Documents\Projects\TNC Randall Preserve Projects\Maps & GIS\MGRS_1km_11S_unprojected"

To make the leaflet map work currently, 

* you run it for find the UTM id for the 1km block including your sites. 
  * For Randal this is LV and LU
* Then you hover over the cells that overlap your sites
  * Make a list of their MGRS numbers
* Use these to subset down to just the ones you need and make a polygon
* Now you can create a 250m grid within just that polygon

11SLV3713, where last four are CCRR where CC is column ID and RR is Row id

```{r mgrs}
library(dplyr)
library(leaflet)
library(leaflet.extras2)
library(sf)
library(geojsonsf)
library(plotrix)
library(htmlwidgets)

MGRS_1km_11S_unprojected = 
  st_read(dsn = file.path("../..",
                    "Maps & GIS",
                    "MGRS_1km_11S_unprojected"),
          layer = "MGRS_1km_11S_unprojected")
# Subset to one or more km^2 block for easier ploting
MGRS_1km_11S_subset = 
  MGRS_1km_11S_unprojected %>%
  filter(kmSQ_ID %in% c("LV", "LU"))
         # substr(MGRS, 8, 9) %in% c("71"))
center = st_coordinates(st_centroid(summarize(MGRS_1km_11S_subset)))
zoom = 10

# centers = st_centroid(MGRS_1km_11S_subset)
# centers$name = MGRS_1km_11S_subset$MGRS

RandallRanches = 
  st_read(dsn = file.path("../..",
                          "Maps & GIS",
                          "2023 (complete GIS files)",
                          "Randall Pasture Boundaries 2023",
                          "Randall Pasture Boundaries 2023"),
          layer = "Randall_Pastures_2023")

RandallRanches = st_transform(RandallRanches, st_crs(MGRS_1km_11S_subset))

pal <- colorFactor(
  palette = "magma",
  domain = RandallRanches$Name,
  na.color = "#737373")

m = leaflet() %>%
  addTiles(group = "OSM (default)") %>%
  addProviderTiles('Esri.WorldImagery', 
                   group = "Esri World Imagery") %>%
  setView(center[1], center[2], zoom) %>%
  addPolygons(data = MGRS_1km_11S_subset,
              fill = F,
              color="black", 
              opacity=10.8,
              label = ~MGRS,
              group = "MGRS") %>%
  # addLabelOnlyMarkers(data = centers,
  #                   label = ~name,
  #                   labelOptions = labelOptions( # noHide = TRUE,
  #                                           direction = 'top',
  #                                           textOnly = TRUE)) %>%
  addPolygons(data = RandallRanches,
              fill = F,
              color= ~pal(Name), 
              opacity=10.8,
              label = ~Name,
              group = "Ranch") %>%
  addLayersControl(
    baseGroups = c("Esri World Imagery", "OSM (default)"),
    overlayGroups = c("MGRS", "Ranch"),
    position = "bottomright",
    options = layersControlOptions(collapsed = TRUE))


m
saveWidget(m, file = "MGRSgridcellpicker.html")

# Subset to one or more km^2 block for easier plotting
MGRS_1km_11S_subset2 = 
  MGRS_1km_11S_subset %>%
  filter(kmSQ_ID %in% c("LV"),
         substr(MGRS, 8, 9) %in% 13:19,
         substr(MGRS, 6, 7) %in% 35:43)
center2 = st_coordinates(st_centroid(summarize(MGRS_1km_11S_subset2)))
zoom2 = 12
BCWest = RandallRanches %>% filter(Name == "B&C West")
MGRS_1km_11S_intersect = st_intersection(MGRS_1km_11S_subset, BCWest)

m2 = leaflet() %>%
  addTiles(group = "OSM (default)") %>%
  addProviderTiles('Esri.WorldImagery', 
                   group = "Esri World Imagery") %>%
  setView(center2[1], center2[2], zoom2) %>%
  addPolygons(data = MGRS_1km_11S_subset2,
              fill = F,
              color="black", 
              opacity=10.8,
              label = ~MGRS,
              group = "MGRS") %>%
  addPolygons(data = RandallRanches,
              fill = F,
              color= ~pal(Name), 
              opacity=10.8,
              label = ~Name,
              group = "Ranch") %>%
  addLayersControl(
    baseGroups = c("Esri World Imagery", "OSM (default)"),
    overlayGroups = c("MGRS", "Ranch"),
    position = "bottomright",
    options = layersControlOptions(collapsed = TRUE))


m2
saveWidget(m, file = "MGRSgridcellViewer.html")

# Another approach using st_intersection
BCWest = RandallRanches %>% filter(Name == "B&C West")
st_intersection(MGRS_1km_11S_subset2, BCWest)
```

```{r grts}
library(spsurvey)
library(sf)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
